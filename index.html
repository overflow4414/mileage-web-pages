<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KE ë§ˆì¼ë¦¬ì§€ ì¢Œì„ ê²€ìƒ‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --ke-blue: #00256c;
            --ke-sky: #0066b3;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Glass effect */
        .glass {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.85);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-soft {
            animation: pulse-soft 2s ease-in-out infinite;
        }
        
        /* Route card hover */
        .route-card {
            transition: all 0.2s ease;
        }
        .route-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }
        
        /* Date cell */
        .date-cell {
            transition: all 0.15s ease;
        }
        .date-cell:hover {
            transform: scale(1.08);
            z-index: 10;
        }
        
        /* Region tabs */
        .region-tab {
            transition: all 0.2s ease;
        }
        .region-tab.active {
            background: linear-gradient(135deg, #0066b3, #00256c);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 102, 179, 0.4);
        }
        
        /* Class badge colors */
        .badge-first { background: linear-gradient(135deg, #9333ea, #7c3aed); }
        .badge-business { background: linear-gradient(135deg, #059669, #10b981); }
        .badge-economy { background: linear-gradient(135deg, #2563eb, #3b82f6); }
        .badge-premium { background: linear-gradient(135deg, #d97706, #f59e0b); }
        
        /* Calendar view */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: default;
            transition: all 0.15s ease;
        }
        .calendar-day.available {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            border: 2px solid #22c55e;
        }
        .calendar-day.available:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }
        .calendar-day.unavailable {
            background: #f8fafc;
            color: #94a3b8;
        }
        .calendar-day.header {
            font-weight: 600;
            color: #64748b;
            background: transparent;
        }
        .calendar-day.sunday { color: #ef4444; }
        .calendar-day.saturday { color: #3b82f6; }
        
        /* Responsive */
        @media (max-width: 640px) {
            .calendar-grid { gap: 2px; }
            .calendar-day { font-size: 0.75rem; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-6 md:py-8">
        
        <!-- Header -->
        <header class="mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-slate-800 flex items-center gap-3">
                        <span class="text-3xl">âœˆï¸</span>
                        <span>KE ë§ˆì¼ë¦¬ì§€ ì¢Œì„ ê²€ìƒ‰</span>
                    </h1>
                    <p class="text-sm text-slate-500 mt-2">
                        ì¶œë°œ: <span class="font-semibold text-sky-700">ì¸ì²œ (ICN)</span> Â· 
                        ì—…ë°ì´íŠ¸: <span id="updated-at" class="font-mono text-xs bg-slate-100 px-2 py-1 rounded">-</span>
                    </p>
                </div>
                <div class="flex gap-2">
                    <button id="view-toggle" class="px-4 py-2 rounded-lg bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 text-sm font-medium transition flex items-center gap-2">
                        <span id="view-icon">ğŸ“…</span>
                        <span id="view-text">ìº˜ë¦°ë” ë³´ê¸°</span>
                    </button>
                    <a href="https://www.koreanair.com/booking/book-and-manage/award-seat-availability" 
                       target="_blank" 
                       class="px-4 py-2 rounded-lg bg-gradient-to-r from-sky-600 to-blue-700 text-white hover:from-sky-700 hover:to-blue-800 text-sm font-medium shadow-lg shadow-sky-200 transition">
                        ëŒ€í•œí•­ê³µ ì˜ˆì•½ â†’
                    </a>
                </div>
            </div>
        </header>
        
        <!-- Filters -->
        <div class="glass rounded-2xl shadow-lg border border-white/50 p-4 md:p-6 mb-6">
            
            <!-- Region Tabs -->
            <div class="mb-4">
                <label class="block text-sm font-semibold text-slate-700 mb-3">ì§€ì—­ ì„ íƒ</label>
                <div class="flex flex-wrap gap-2" id="region-tabs">
                    <button data-region="all" class="region-tab active px-4 py-2 rounded-full text-sm font-medium bg-slate-100 text-slate-700">
                        ğŸŒ ì „ì²´
                    </button>
                    <button data-region="asia" class="region-tab px-4 py-2 rounded-full text-sm font-medium bg-slate-100 text-slate-700">
                        ğŸŒ ì•„ì‹œì•„
                    </button>
                    <button data-region="americas" class="region-tab px-4 py-2 rounded-full text-sm font-medium bg-slate-100 text-slate-700">
                        ğŸŒ ë¯¸ì£¼
                    </button>
                    <button data-region="europe" class="region-tab px-4 py-2 rounded-full text-sm font-medium bg-slate-100 text-slate-700">
                        ğŸ‡ªğŸ‡º ìœ ëŸ½
                    </button>
                    <button data-region="oceania" class="region-tab px-4 py-2 rounded-full text-sm font-medium bg-slate-100 text-slate-700">
                        ğŸ¦˜ ì˜¤ì„¸ì•„ë‹ˆì•„
                    </button>
                    <button data-region="resort" class="region-tab px-4 py-2 rounded-full text-sm font-medium bg-slate-100 text-slate-700">
                        ğŸï¸ íœ´ì–‘ì§€
                    </button>
                </div>
            </div>
            
            <!-- Class Filter + Destination -->
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">í´ë˜ìŠ¤</label>
                    <div class="flex flex-wrap gap-2" id="class-filters">
                        <button data-class="all" class="class-btn active px-3 py-1.5 rounded-full text-sm font-medium bg-slate-800 text-white">ì „ì²´</button>
                        <button data-class="first" class="class-btn px-3 py-1.5 rounded-full text-sm font-medium bg-purple-100 text-purple-700 hover:bg-purple-200">í¼ìŠ¤íŠ¸</button>
                        <button data-class="business" class="class-btn px-3 py-1.5 rounded-full text-sm font-medium bg-emerald-100 text-emerald-700 hover:bg-emerald-200">í”„ë ˆìŠ¤í‹°ì§€</button>
                        <button data-class="economy" class="class-btn px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-700 hover:bg-blue-200">ì¼ë°˜ì„</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">ë„ì°©ì§€ ê²€ìƒ‰</label>
                    <div class="relative">
                        <input type="text" id="dest-search" placeholder="ë„ì‹œëª… ë˜ëŠ” ê³µí•­ì½”ë“œ (ì˜ˆ: ë„ì¿„, LAX)" 
                               class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-sky-500 focus:border-transparent text-sm">
                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">ğŸ”</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stats Bar -->
        <div class="flex flex-wrap items-center gap-4 mb-6 text-sm">
            <div class="flex items-center gap-2 px-3 py-1.5 bg-white rounded-full shadow-sm">
                <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                <span id="stat-routes" class="font-semibold text-slate-700">0</span>
                <span class="text-slate-500">ë…¸ì„ </span>
            </div>
            <div class="flex items-center gap-2 px-3 py-1.5 bg-white rounded-full shadow-sm">
                <span class="w-2 h-2 rounded-full bg-sky-500"></span>
                <span id="stat-dates" class="font-semibold text-slate-700">0</span>
                <span class="text-slate-500">ê°€ëŠ¥ì¼</span>
            </div>
            <div class="flex items-center gap-2 px-3 py-1.5 bg-white rounded-full shadow-sm">
                <span class="w-2 h-2 rounded-full bg-purple-500 animate-pulse-soft"></span>
                <span id="stat-first" class="font-semibold text-slate-700">0</span>
                <span class="text-slate-500">í¼ìŠ¤íŠ¸</span>
            </div>
        </div>
        
        <!-- Loading -->
        <div id="loading" class="text-center py-20">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-sky-200 border-t-sky-600 mb-4"></div>
            <p class="text-slate-500">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
        
        <!-- Content: Card View -->
        <div id="content-cards" class="grid gap-4 md:gap-6 hidden"></div>
        
        <!-- Content: Calendar View -->
        <div id="content-calendar" class="hidden">
            <div id="calendar-dest-select" class="mb-6">
                <label class="block text-sm font-semibold text-slate-700 mb-2">ë…¸ì„  ì„ íƒ</label>
                <select id="calendar-route" class="w-full md:w-auto px-4 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-sky-500 text-sm">
                    <option value="">ë…¸ì„ ì„ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            <div id="calendar-grid-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
        
        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-20">
            <div class="text-6xl mb-4">ğŸ˜”</div>
            <p class="text-slate-500 text-lg">ì„ íƒí•œ ì¡°ê±´ì— ë§ëŠ” ì¢Œì„ì´ ì—†ìŠµë‹ˆë‹¤</p>
            <p class="text-slate-400 text-sm mt-2">ë‹¤ë¥¸ ì§€ì—­ì´ë‚˜ í´ë˜ìŠ¤ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”</p>
        </div>
        
        <!-- Footer -->
        <footer class="mt-12 pt-6 border-t border-slate-200 text-center text-sm text-slate-500">
            <p>ğŸ’¡ ë°ì´í„°ëŠ” ìë™ìœ¼ë¡œ ìˆ˜ì§‘ë˜ë©° ì°¸ê³ ìš©ì…ë‹ˆë‹¤. ì •í™•í•œ ì •ë³´ëŠ” ëŒ€í•œí•­ê³µì—ì„œ í™•ì¸í•˜ì„¸ìš”.</p>
            <p class="mt-2">
                Made with â¤ï¸ Â· 
                <a href="https://github.com/overflow4414/mileage-web" target="_blank" class="text-sky-600 hover:underline">GitHub</a>
            </p>
        </footer>
    </div>

    <script>
        // ============================================
        // Data & State
        // ============================================
        let allData = {};
        let currentView = 'cards'; // 'cards' or 'calendar'
        let filters = {
            region: 'all',
            class: 'all',
            search: ''
        };

        // Region mapping
        const REGIONS = {
            asia: ['NRT', 'HND', 'KIX', 'FUK', 'NGO', 'CTS', 'OKA', 'TPE', 'HKG', 'BKK', 'SGN', 'SIN', 'MNL', 'KUL', 'PNH', 'HAN'],
            americas: ['LAX', 'SFO', 'JFK', 'SEA', 'LAS', 'IAD', 'ORD', 'DFW', 'ATL', 'HNL', 'YVR', 'YYZ'],
            europe: ['CDG', 'FRA', 'LHR', 'FCO', 'BCN', 'MAD', 'AMS', 'ZRH', 'VIE', 'PRG', 'IST'],
            oceania: ['SYD', 'MEL', 'BNE', 'AKL'],
            resort: ['HNL', 'GUM', 'SPN', 'DPS', 'CEB', 'DAD', 'OKA']
        };

        // Airport names
        const AIRPORT_NAMES = {
            // Americas
            'LAX': 'ë¡œìŠ¤ì•¤ì ¤ë ˆìŠ¤', 'SFO': 'ìƒŒí”„ë€ì‹œìŠ¤ì½”', 'JFK': 'ë‰´ìš•', 'SEA': 'ì‹œì• í‹€',
            'LAS': 'ë¼ìŠ¤ë² ê°€ìŠ¤', 'IAD': 'ì›Œì‹±í„´DC', 'ORD': 'ì‹œì¹´ê³ ', 'DFW': 'ëŒˆëŸ¬ìŠ¤',
            'ATL': 'ì• í‹€ëœíƒ€', 'HNL': 'í˜¸ë†€ë£°ë£¨', 'YVR': 'ë°´ì¿ ë²„', 'YYZ': 'í† ë¡ í† ',
            // Europe
            'CDG': 'íŒŒë¦¬', 'FRA': 'í”„ë‘í¬í‘¸ë¥´íŠ¸', 'LHR': 'ëŸ°ë˜', 'FCO': 'ë¡œë§ˆ',
            'BCN': 'ë°”ë¥´ì…€ë¡œë‚˜', 'MAD': 'ë§ˆë“œë¦¬ë“œ', 'AMS': 'ì•”ìŠ¤í…Œë¥´ë‹´', 'ZRH': 'ì·¨ë¦¬íˆ',
            'VIE': 'ë¹ˆ', 'PRG': 'í”„ë¼í•˜', 'IST': 'ì´ìŠ¤íƒ„ë¶ˆ',
            // Asia
            'NRT': 'ë„ì¿„(ë‚˜ë¦¬íƒ€)', 'HND': 'ë„ì¿„(í•˜ë„¤ë‹¤)', 'KIX': 'ì˜¤ì‚¬ì¹´', 'FUK': 'í›„ì¿ ì˜¤ì¹´',
            'NGO': 'ë‚˜ê³ ì•¼', 'CTS': 'ì‚¿í¬ë¡œ', 'OKA': 'ì˜¤í‚¤ë‚˜ì™€', 'TPE': 'íƒ€ì´ë² ì´',
            'HKG': 'í™ì½©', 'BKK': 'ë°©ì½•', 'SGN': 'í˜¸ì¹˜ë¯¼', 'SIN': 'ì‹±ê°€í¬ë¥´',
            'MNL': 'ë§ˆë‹ë¼', 'CEB': 'ì„¸ë¶€', 'DPS': 'ë°œë¦¬', 'KUL': 'ì¿ ì•Œë¼ë£¸í‘¸ë¥´',
            'PNH': 'í”„ë†ˆíœ', 'HAN': 'í•˜ë…¸ì´', 'DAD': 'ë‹¤ë‚­',
            // Oceania
            'SYD': 'ì‹œë“œë‹ˆ', 'MEL': 'ë©œë²„ë¥¸', 'BNE': 'ë¸Œë¦¬ì¦ˆë²ˆ', 'AKL': 'ì˜¤í´ëœë“œ',
            // Others
            'GUM': 'ê´Œ', 'SPN': 'ì‚¬ì´íŒ'
        };

        // ============================================
        // Helpers
        // ============================================
        function getAirportName(code) {
            return AIRPORT_NAMES[code] || code;
        }

        function getDestCode(route) {
            return route.split('-')[1];
        }

        function matchesRegion(destCode, region) {
            if (region === 'all') return true;
            return REGIONS[region]?.includes(destCode) || false;
        }

        function matchesClass(classes, classFilter) {
            if (classFilter === 'all') return true;
            return classes.some(c => c === classFilter || (classFilter === 'business' && c === 'prestige'));
        }

        // Open KE booking page
        function openBooking(route, dateStr, classLabel) {
            const [origin, dest] = route.split('-');
            const destName = getAirportName(dest);
            const dateObj = new Date(dateStr);
            const year = dateObj.getFullYear();
            const month = dateObj.getMonth() + 1;
            const day = dateObj.getDate();
            const monthStr = `${year}ë…„ ${month}ì›”`;
            
            const message = `${destName}(${dest}) ${month}/${day} ${classLabel} ì˜ˆì•½ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            
            if (confirm(message)) {
                // KE ë§ˆì¼ë¦¬ì§€ ì¢Œì„ ê²€ìƒ‰ URL
                // Note: KE site doesn't support direct date link, so we go to the main award page
                const keUrl = 'https://www.koreanair.com/booking/best-awards';
                window.open(keUrl, '_blank');
            }
        }

        function matchesSearch(route, search) {
            if (!search) return true;
            const dest = getDestCode(route);
            const name = getAirportName(dest).toLowerCase();
            const searchLower = search.toLowerCase();
            return dest.toLowerCase().includes(searchLower) || name.includes(searchLower);
        }

        function getClassBadge(classType) {
            const badges = {
                'first': { label: 'í¼ìŠ¤íŠ¸', class: 'badge-first' },
                'business': { label: 'í”„ë ˆìŠ¤í‹°ì§€', class: 'badge-business' },
                'prestige': { label: 'í”„ë ˆìŠ¤í‹°ì§€', class: 'badge-business' },
                'economy': { label: 'ì¼ë°˜ì„', class: 'badge-economy' },
                'premium_economy': { label: 'í”„ë¦¬ë¯¸ì—„', class: 'badge-premium' }
            };
            return badges[classType] || { label: classType, class: 'bg-slate-500' };
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            return {
                month: d.getMonth() + 1,
                day: d.getDate(),
                dayName: days[d.getDay()],
                isWeekend: d.getDay() === 0 || d.getDay() === 6,
                isSunday: d.getDay() === 0,
                isSaturday: d.getDay() === 6
            };
        }

        // ============================================
        // Render Functions
        // ============================================
        function renderCardView() {
            const container = document.getElementById('content-cards');
            const emptyState = document.getElementById('empty-state');
            container.innerHTML = '';

            const routes = allData.routes || {};
            const filteredRoutes = [];

            Object.entries(routes).forEach(([route, dates]) => {
                const dest = getDestCode(route);
                
                // Apply filters
                if (!matchesRegion(dest, filters.region)) return;
                if (!matchesSearch(route, filters.search)) return;

                // Filter dates by class
                let filteredDates = {};
                Object.entries(dates).forEach(([dateStr, classes]) => {
                    if (matchesClass(classes, filters.class)) {
                        filteredDates[dateStr] = classes;
                    }
                });

                if (Object.keys(filteredDates).length === 0) return;

                filteredRoutes.push({ route, dest, dates: filteredDates });
            });

            // Sort by date count (most available first)
            filteredRoutes.sort((a, b) => Object.keys(b.dates).length - Object.keys(a.dates).length);

            if (filteredRoutes.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
            } else {
                container.classList.remove('hidden');
                emptyState.classList.add('hidden');

                filteredRoutes.forEach(({ route, dest, dates }) => {
                    container.appendChild(createRouteCard(route, dest, dates));
                });
            }

            updateStats(filteredRoutes);
        }

        function createRouteCard(route, dest, dates) {
            const card = document.createElement('div');
            card.className = 'route-card glass rounded-2xl shadow-lg border border-white/50 p-5 animate-fade-in';

            const sortedDates = Object.keys(dates).sort();
            const hasFirst = Object.values(dates).some(c => c.includes('first'));
            const hasBusiness = Object.values(dates).some(c => c.includes('business') || c.includes('prestige'));

            // Find best class for highlight
            let highlight = '';
            if (hasFirst) highlight = 'border-l-4 border-l-purple-500';
            else if (hasBusiness) highlight = 'border-l-4 border-l-emerald-500';
            else highlight = 'border-l-4 border-l-blue-500';

            card.className += ` ${highlight}`;

            card.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="text-3xl font-bold text-slate-300">ICN</div>
                        <svg class="w-6 h-6 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                        </svg>
                        <div>
                            <div class="text-2xl font-bold text-sky-700">${dest}</div>
                            <div class="text-sm text-slate-500">${getAirportName(dest)}</div>
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="text-2xl font-bold text-slate-700">${sortedDates.length}</span>
                        <span class="text-xs text-slate-500">ê°€ëŠ¥ì¼</span>
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-2 mb-4">
                    ${hasFirst ? '<span class="px-2 py-1 rounded-full text-xs font-semibold text-white badge-first">í¼ìŠ¤íŠ¸</span>' : ''}
                    ${hasBusiness ? '<span class="px-2 py-1 rounded-full text-xs font-semibold text-white badge-business">í”„ë ˆìŠ¤í‹°ì§€</span>' : ''}
                    ${!hasFirst && !hasBusiness ? '<span class="px-2 py-1 rounded-full text-xs font-semibold text-white badge-economy">ì¼ë°˜ì„</span>' : ''}
                </div>
                
                <div class="grid grid-cols-7 sm:grid-cols-10 md:grid-cols-12 lg:grid-cols-14 gap-1">
                    ${sortedDates.map(dateStr => {
                        const classes = dates[dateStr];
                        const { month, day, dayName, isSunday, isSaturday } = formatDate(dateStr);
                        const isFirst = classes.includes('first');
                        const isBusiness = classes.includes('business') || classes.includes('prestige');
                        
                        let bgClass = 'bg-blue-50 border-blue-200 hover:bg-blue-100';
                        if (isFirst) bgClass = 'bg-purple-50 border-purple-200 hover:bg-purple-100';
                        else if (isBusiness) bgClass = 'bg-emerald-50 border-emerald-200 hover:bg-emerald-100';
                        
                        let textClass = 'text-slate-700';
                        if (isSunday) textClass = 'text-red-500';
                        else if (isSaturday) textClass = 'text-blue-500';
                        
                        const classLabel = isFirst ? 'í¼ìŠ¤íŠ¸' : (isBusiness ? 'í”„ë ˆìŠ¤í‹°ì§€' : 'ì¼ë°˜ì„');
                        
                        return `
                            <div class="date-cell flex flex-col items-center p-1.5 rounded-lg border ${bgClass} cursor-pointer transition-all hover:scale-105" 
                                 title="${dateStr} - ${classes.join(', ')}"
                                 onclick="openBooking('${route}', '${dateStr}', '${classLabel}')">
                                <span class="text-[9px] text-slate-400">${dayName}</span>
                                <span class="text-xs font-bold ${textClass}">${month}/${day}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            return card;
        }

        function renderCalendarView() {
            const container = document.getElementById('calendar-grid-container');
            const select = document.getElementById('calendar-route');
            
            // Populate route selector
            const routes = allData.routes || {};
            const filteredRoutes = Object.keys(routes).filter(route => {
                const dest = getDestCode(route);
                return matchesRegion(dest, filters.region) && matchesSearch(route, filters.search);
            }).sort();

            select.innerHTML = '<option value="">ë…¸ì„ ì„ ì„ íƒí•˜ì„¸ìš”</option>' +
                filteredRoutes.map(route => {
                    const dest = getDestCode(route);
                    const dateCount = Object.keys(routes[route]).length;
                    return `<option value="${route}">${dest} ${getAirportName(dest)} (${dateCount}ì¼)</option>`;
                }).join('');

            if (!select.value && filteredRoutes.length > 0) {
                select.value = filteredRoutes[0];
            }

            renderCalendarForRoute(select.value);
        }

        function renderCalendarForRoute(route) {
            const container = document.getElementById('calendar-grid-container');
            container.innerHTML = '';

            if (!route || !allData.routes?.[route]) {
                container.innerHTML = '<p class="text-slate-500 col-span-full text-center py-10">ë…¸ì„ ì„ ì„ íƒí•˜ì„¸ìš”</p>';
                return;
            }

            const dates = allData.routes[route];
            const availableDates = new Set(Object.keys(dates));

            // Get month range (current to +11 months)
            const now = new Date();
            const months = [];
            for (let i = 0; i < 12; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                months.push({ year: d.getFullYear(), month: d.getMonth() });
            }

            months.forEach(({ year, month }) => {
                const monthCard = document.createElement('div');
                monthCard.className = 'glass rounded-xl p-4 border border-white/50 animate-fade-in';

                const monthName = `${year}ë…„ ${month + 1}ì›”`;
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                let calendarHTML = `
                    <h3 class="text-lg font-bold text-slate-700 mb-3">${monthName}</h3>
                    <div class="calendar-grid">
                        <div class="calendar-day header sunday">ì¼</div>
                        <div class="calendar-day header">ì›”</div>
                        <div class="calendar-day header">í™”</div>
                        <div class="calendar-day header">ìˆ˜</div>
                        <div class="calendar-day header">ëª©</div>
                        <div class="calendar-day header">ê¸ˆ</div>
                        <div class="calendar-day header saturday">í† </div>
                `;

                // Empty cells for first week
                for (let i = 0; i < firstDay; i++) {
                    calendarHTML += '<div class="calendar-day"></div>';
                }

                // Days
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isAvailable = availableDates.has(dateStr);
                    const classes = dates[dateStr] || [];
                    const dayOfWeek = new Date(year, month, day).getDay();
                    
                    let dayClass = isAvailable ? 'available' : 'unavailable';
                    if (dayOfWeek === 0) dayClass += ' sunday';
                    if (dayOfWeek === 6) dayClass += ' saturday';

                    let indicator = '';
                    if (isAvailable) {
                        if (classes.includes('first')) {
                            indicator = '<span class="w-1.5 h-1.5 rounded-full bg-purple-500"></span>';
                        } else if (classes.includes('business') || classes.includes('prestige')) {
                            indicator = '<span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>';
                        }
                    }

                    calendarHTML += `
                        <div class="calendar-day ${dayClass}" title="${isAvailable ? classes.join(', ') : 'ì¢Œì„ ì—†ìŒ'}">
                            <span>${day}</span>
                            ${indicator}
                        </div>
                    `;
                }

                calendarHTML += '</div>';
                monthCard.innerHTML = calendarHTML;
                container.appendChild(monthCard);
            });
        }

        function updateStats(filteredRoutes) {
            const totalRoutes = filteredRoutes.length;
            let totalDates = 0;
            let firstCount = 0;

            filteredRoutes.forEach(({ dates }) => {
                totalDates += Object.keys(dates).length;
                Object.values(dates).forEach(classes => {
                    if (classes.includes('first')) firstCount++;
                });
            });

            document.getElementById('stat-routes').textContent = totalRoutes;
            document.getElementById('stat-dates').textContent = totalDates;
            document.getElementById('stat-first').textContent = firstCount;
        }

        function render() {
            if (currentView === 'cards') {
                document.getElementById('content-cards').classList.remove('hidden');
                document.getElementById('content-calendar').classList.add('hidden');
                renderCardView();
            } else {
                document.getElementById('content-cards').classList.add('hidden');
                document.getElementById('content-calendar').classList.remove('hidden');
                renderCalendarView();
            }
        }

        // ============================================
        // Event Handlers
        // ============================================
        function setupEventListeners() {
            // View toggle
            document.getElementById('view-toggle').addEventListener('click', () => {
                currentView = currentView === 'cards' ? 'calendar' : 'cards';
                document.getElementById('view-icon').textContent = currentView === 'cards' ? 'ğŸ“…' : 'ğŸ“‹';
                document.getElementById('view-text').textContent = currentView === 'cards' ? 'ìº˜ë¦°ë” ë³´ê¸°' : 'ì¹´ë“œ ë³´ê¸°';
                render();
            });

            // Region tabs
            document.querySelectorAll('.region-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelectorAll('.region-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    filters.region = e.target.dataset.region;
                    render();
                });
            });

            // Class filters
            document.querySelectorAll('.class-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.class-btn').forEach(b => {
                        b.classList.remove('active', 'bg-slate-800', 'text-white');
                    });
                    e.target.classList.add('active', 'bg-slate-800', 'text-white');
                    filters.class = e.target.dataset.class;
                    render();
                });
            });

            // Search
            let searchTimeout;
            document.getElementById('dest-search').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filters.search = e.target.value;
                    render();
                }, 300);
            });

            // Calendar route select
            document.getElementById('calendar-route').addEventListener('change', (e) => {
                renderCalendarForRoute(e.target.value);
            });
        }

        // ============================================
        // Load Data
        // ============================================
        async function loadData() {
            try {
                const res = await fetch('data.json?t=' + Date.now(), { cache: 'no-store' });
                if (!res.ok) throw new Error('ë°ì´í„° íŒŒì¼ ì—†ìŒ');
                
                allData = await res.json();
                
                const updatedAt = allData.updatedAt || 'ì•Œ ìˆ˜ ì—†ìŒ';
                document.getElementById('updated-at').textContent = updatedAt;
                
                document.getElementById('loading').classList.add('hidden');
                render();

            } catch (e) {
                document.getElementById('loading').innerHTML = `
                    <div class="text-red-500 text-lg mb-2">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ğŸ˜¢</div>
                    <p class="text-sm text-slate-400">${e.message}</p>
                `;
            }
        }

        // ============================================
        // Initialize
        // ============================================
        setupEventListeners();
        loadData();
    </script>
</body>
</html>
